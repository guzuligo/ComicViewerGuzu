<!DOCTYPE html>
<!--This code was create with support of Windsurf Commands-->
<html>
<head>
    <title>Comic</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #000000;
            overflow: hidden;
        }
        #page {
            position: absolute;
            background-color: rgb(15, 12, 12);
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #page img {
            position: absolute;
            width: auto;
            height: auto;
            max-width: 100%;
            max-height: 100%;
        }
        #navBar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10%;
            background-color: black;
            color: white;
            font-size: 20px;
            text-align: center;
            display: none;
        }
        #navBar a {
            color: white;
            text-decoration: none;
        }
        #navBar a:hover {
            color: red;
        }
    </style>

    <style>
        /*Special effects*/
        @keyframes leftSlide    { from { transform:translateX(-50px); } to { transform:translateX(0); } }
        @keyframes rightSlide   { from { transform:translateX( 50px); } to { transform:translateX(0); } }
        @keyframes upSlide      { from { transform:translateY(-50px); } to { transform:translateY(0); } }
        @keyframes downSlide    { from { transform:translateY( 50px); } to { transform:translateY(0); } }
        @keyframes shake {
            00% { transform: translateY(-10px) translateX(-10px); }
            05% { transform: translateY( 10px) translateX(-10px); }
            10% { transform: translateY(-9px) translateX( 9px); }
            15% { transform: translateY( 9px) translateX( 9px); }
            20% { transform: translateY(-8px) translateX(-8px); }
            25% { transform: translateY( 8px) translateX(-8px); }
            30% { transform: translateY(-7px) translateX( 7px); }
            35% { transform: translateY( 7px) translateX( 7px); }
            40% { transform: translateY(-6px) translateX(-6px); }
            45% { transform: translateY( 6px) translateX(-6px); }
            50% { transform: translateY(-5px) translateX( 5px); }
            55% { transform: translateY( 5px) translateX( 5px); }
            60% { transform: translateY(-4px) translateX(-4px); }
            65% { transform: translateY( 4px) translateX(-4px); }
            70% { transform: translateY(-3px) translateX( 3px); }
            75% { transform: translateY( 3px) translateX( 3px); }
            80% { transform: translateY(-2px) translateX(-2px); }
            85% { transform: translateY( 2px) translateX(-2px); }
            90% { transform: translateY(-1px) translateX( 1px); }
            95% { transform: translateY( 1px) translateX( 1px); }
            100% { transform: translateY(0); }
        }
        
    </style>
    <script src="comicJson.js"></script>
</head>
<body>
    <div id="page"></div>
    <div id="navBar">
        <a href="#" id="navBarPage1">1</a>
        <a href="#" id="navBarPage2">2</a>
        <a href="#" id="navBarPage3">3</a>
        <a href="#" id="navBarPage4">4</a>
        <a href="#" id="navBarPage5">5</a>
        <a href="#" id="navBarPage6">6</a>
        <a href="#" id="navBarPage7">7</a>
        <a href="#" id="navBarPage8">8</a>
        <a href="#" id="navBarPage9">9</a>
        <a href="#" id="navBarPage10">10</a>
    </div>
    <script>
        var currentPage = 1;
        var pages = [];
        var masterVolume = 1;
        var navigationBarPages = 20;
        var assetsFolder = "assets";
        var lastTime = performance.now();
        var interval = setInterval(function () {
            var time = performance.now();
            var deltaTime = time - lastTime;
            lastTime = time;
            var page = pages[currentPage-1];
            var pageElement = document.getElementById("page");
            console.log(page.AutoNext,currentPage)
            //go to next page if time is up
            if (page.AutoNext > 0 && pageElement.time+page.AutoNext*1000 <= time) {
                loadPage(currentPage + 1);
                return;
            }
            //add images and wait until their delay finish before adding
            var page = pages[currentPage - 1];
            if (page && page.Elements) {
                for (var j = 0; j < page.Elements.length; j++) {
                    var element = page.Elements[j];
                    if (element.time <= time && !element.added) {
                        var image = document.createElement("img");
                        image.src = assetsFolder + "/" + element.File;
                        image.id = element.File;
                        image.style.zIndex = element.z;
                        image.style.position = "absolute";
                        image.style.left = element.x;
                        image.style.top = element.y;
                        image.element= element;
                        if (element.CSS) {
                            image.style.cssText += element.CSS;
                        }
                        document.getElementById("page").appendChild(image);
                        element.added = true;
                    }
                }
            }
        }, 1000 / 30);
        var loadJSON = function (json) {

            //get resolution and set page size to fix it to the aspect ration of that resolution
            var resolution = json["Resolution"] || null;
            if (resolution) {
                document.getElementById("page").style.overflow = "hidden";
                var r = /\d+/g;
                var dims = resolution.match(r);
                if (dims.length == 2) {
                    var width = parseInt(dims[0]);
                    var height = parseInt(dims[1]);
                    var aspectRatio = width / height;
                    var innerWidth = window.innerWidth;
                    var innerHeight = window.innerHeight;
                    if (innerWidth / innerHeight > aspectRatio) {
                        document.getElementById("page").style.width = innerHeight * aspectRatio + "px";
                        document.getElementById("page").style.height = innerHeight + "px";
                    } else {
                        document.getElementById("page").style.width = innerWidth + "px";
                        document.getElementById("page").style.height = innerWidth / aspectRatio + "px";
                    }
                    window.addEventListener("resize", function () {
                        var innerWidth = window.innerWidth;
                        var innerHeight = window.innerHeight;
                        if (innerWidth / innerHeight > aspectRatio) {
                            document.getElementById("page").style.width = innerHeight * aspectRatio + "px";
                            document.getElementById("page").style.height = innerHeight + "px";
                        } else {
                            document.getElementById("page").style.width = innerWidth + "px";
                            document.getElementById("page").style.height = innerWidth / aspectRatio + "px";
                        }
                    });

                    //Make #page img fit to #page
                    //document.getElementById("page").style.display = "flex";


                }
            }
            masterVolume = json["Master Volume"] || 1;
            navigationBarPages = json["Navigation Bar Pages"] || 20;
            assetsFolder = json["assets folder"] || "assets";
            var page;
            for (var i = 0; i < json.Pages.length; i++) {
                page = json.Pages[i];
                page.AutoNext = page.AutoNext || 0;
                page.Clean = page.Clean || false;
                page.number=i+1;
                var element;
                for (var j = 0; j < page.Elements.length; j++) {
                    element = page.Elements[j];
                    element.CSS = element.CSS || "";
                    element.z = element.z || 0;
                    element.persist = element.persist || 1;
                    element.delay = element.delay || 0;
                    element.page = i + 1;
                    element.id = element.File;
                    element.added = false;
                }
            }
            pages = json.Pages;
            var css = json["CSS styles"] || "";
            var style = document.createElement("style");
            style.type = "text/css";
            style.innerHTML = css;
            document.head.appendChild(style);

            var navBar = document.getElementById("navBar");
            while (navBar.firstChild) {
                navBar.removeChild(navBar.firstChild);
            }
            for (var i = 0; i < pages.length; i++) {
                var a = document.createElement("a");
                a.id = "navBarPage" + (i + 1);
                a.href = "javascript:loadPage(" + (i + 1) + ");";
                a.innerHTML = (i + 1) + " ";
                navBar.appendChild(a);
            }

            loadPage(currentPage);
        };
        var loadPage = function (page) {
            page = Math.min(Math.max(page, 1), pages.length);
            var pageConfig = pages[page - 1];
            var pageElement = document.getElementById("page");
            pageElement.time = lastTime;
            currentPage = page;
            //Distroy the page if clean is true
            if (!pageConfig.Clean) 
                cleanPage(pageElement, pageConfig)
            else {
                // Remove old images and ones that don't persist
                var childNodes = pageElement.childNodes;
                for (var i = childNodes.length - 1; i >= 0; i--) {
                    var child = childNodes[i];
                    if (child.nodeType == 1) {
                        pageElement.removeChild(child);
                    }
                }
            }
                
            //Add new elements
            addPageElements(pageElement, pageConfig);


            //Add persistant elements from previous pages
            for (var i = page - 2; i >= 0; i--) {
                var pageConfig = pages[i];
                for (var j = 0; j < pageConfig.Elements.length; j++) {
                    var element = pageConfig.Elements[j];
                    if (element.persist > 1) 
                        addPageElements(pageElement, {Elements:[element]}, false);
                }
                if (pageConfig.Clean) {
                    break;
                }
            }
        };

        var cleanPage = function (pageElement, pageConfig) {
            var childNodes = pageElement.childNodes;
            for (var i = childNodes.length - 1; i >= 0; i--) {
                var child = childNodes[i];
                if (child.nodeType == 1) {
                    var element = null;
                    for (var j = 0; j < pages.length; j++) {
                        var pageElements = pages[j].Elements;
                        for (var k = 0; k < pageElements.length; k++) {
                            if (pageElements[k].id == child.id) {
                                element = pageElements[k];
                                break;
                            }
                        }
                        if (element) break;
                    }

                    // Remove non-persistent images
                    if (child.tagName === 'IMG') {
                        if (element && (element.persist == 1 || currentPage < element.page || currentPage >= element.page + element.persist)) {
                            pageElement.removeChild(child);
                        }
                    }
                    // Remove non-persistent audio using properties on the element
                    else if (child.tagName === 'AUDIO') {
                        var persist = child.persist || 1;
                        var audioPage = child.page || currentPage;
                        if (persist == 1 || currentPage < audioPage || currentPage >= audioPage + persist) {
                            child.pause && child.pause();
                            child.currentTime = 0;
                            pageElement.removeChild(child);
                        }
                    }
                }
            }

            
        };

        //Go to previous page. If it has autoNext, then go to previous one
        //until you either reach a page with no autoNext, or if the total auto next seconds reach 3 seconds
        var prevPage=function(){
            console.log("PrevPage!")
            var sum = 0;
            var i = currentPage;
            while (--i >= 0 && pages[i-1].AutoNext > 0) {
                sum += pages[i-1].AutoNext;
                console.log("AudoNext:",pages[i-1].AutoNext, " Sum:",sum);
                
                if (sum >= 3) break; 
                
            }
            //i++;
            loadPage(i);
            
            //loadPage(currentPage - 1);
        }
        var addPageElements = function (pageElement, pageConfig, force=true) {
            //if (!force){
            //    if (elements[i].page !== currentPage && (elements[i].persist <= 1 || currentPage < elements[i].page || currentPage >= elements[i].page + elements[i].persist)) return;
            //}

            var elements = pageConfig.Elements;
            for (var i = 0; i < elements.length; i++) {
                elements[i].added = false;
                elements[i].time = pageElement.time + elements[i].delay * 1000;
            }
            if (pageConfig.Audio) {
                var audio = pageConfig.Audio;
                for (var i = 0; i < audio.length; i++) {
                    // Check if audio element already exists for this file
                    var existingAudio = pageElement.querySelector('audio[src="' + assetsFolder + "/" + audio[i].File + '"]');
                    if (!existingAudio) {
                        var sound = document.createElement("audio");
                        sound.src = assetsFolder + "/" + audio[i].File;
                        sound.volume = masterVolume * (audio[i].Volume / 100);
                        sound.element = audio[i];
                        // Store persist and page info directly on the audio element
                        sound.persist = audio[i].persist || 1;
                        sound.page = audio[i].page || currentPage;
                        if (audio[i].FadeIn > 0) {
                            sound.addEventListener("canplay", function (e) {
                                e.target.volume = 0;
                                var interval = setInterval(function () {
                                    if (e.target.volume < masterVolume * (audio[i].Volume / 100)) {
                                        e.target.volume += 0.1;
                                    } else {
                                        clearInterval(interval);
                                    }
                                }, 100);
                            });
                        }
                        if (audio[i].FadeOut > 0) {
                            sound.addEventListener("ended", function (e) {
                                var interval = setInterval(function () {
                                    if (e.target.volume > 0) {
                                        e.target.volume -= 0.1;
                                    } else {
                                        clearInterval(interval);
                                    }
                                }, 100);
                            });
                        }
                        pageElement.appendChild(sound);
                        sound.play();
                    }
                }
            }
        };
        document.addEventListener("click", function (e) {
            // Only change page if click is on the page area, not the navigation bar
            if (e.target.id != "navBar" && !e.target.closest("#navBar")) {
                // Check if click is directly on the page element
                var pageElement = document.getElementById("page");
                if (e.target === pageElement || e.target.closest("#page")) {
                    if (e.pageX > window.innerWidth / 2) {
                        loadPage(currentPage + 1);
                    } else if (e.pageX < window.innerWidth / 2) {
                        prevPage();
                    }
                }
            }
            // Only show/hide nav bar if click is on the bottom part of the screen
            if (e.pageY > window.innerHeight - 50) {
                document.getElementById("navBar").style.display = "block";
            } else {
                document.getElementById("navBar").style.display = "none";
            }
        }, false);
        document.addEventListener("touchstart", function (e) {
            if (e.touches[0].target.id != "navBar") {
                // Check if touch is directly on the page element
                var pageElement = document.getElementById("page");
                if (e.touches[0].target === pageElement || e.touches[0].target.closest("#page")) {
                    if (e.touches[0].pageX > window.innerWidth / 2) {
                        loadPage(currentPage + 1);
                    } else if (e.touches[0].pageX < window.innerWidth / 2) {
                        prevPage();
                    }
                }
            }
            if (e.touches[0].pageY > window.innerHeight - 50) {
                document.getElementById("navBar").style.display = "block";
            } else {
                document.getElementById("navBar").style.display = "none";
            }
        }, false);

        //auto load if there is a comicJson
        if (comicJson)
            loadJSON(comicJson);
    </script>
</body>
</html>
